name: 每日美图更换 # 工作流名称

on:
  schedule:
    # 每天 UTC 时间 00:00 运行 (北京时间上午 8:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动触发此工作流

permissions: # 明确授予工作流写入权限
  contents: write # 允许工作流修改仓库内容

jobs:
  update-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download and save image
        run: |
          IMAGE_URL="https://api.kxzjoker.cn/api/wallhere?type=bs"
          IMAGE_NAME="美图.png" # 定义图片名称

          # 使用 curl 下载图片，并保存为指定名称
          # -s 静默模式，不显示进度或错误信息
          # -L 遵循重定向
          # -o 指定输出文件名
          curl -s -L -o "$IMAGE_NAME" "$IMAGE_URL"

          # 检查图片是否成功下载
          if [ ! -f "$IMAGE_NAME" ]; then
            echo "Error: Image download failed."
            exit 1
          fi
          echo "Image downloaded successfully as $IMAGE_NAME."

      - name: Commit and push image
        run: |
          # 配置 Git 用户信息
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 检查文件是否有变化，如果有，则提交并推送
          # git add -N 避免在没有实际变化时创建空blob
          git add "$IMAGE_NAME"
          if ! git diff --cached --quiet "$IMAGE_NAME"; then
            git commit -m "chore: Update daily image (美图.png) [skip ci]"
            git push
            echo "美图.png updated and pushed."
          else
            echo "美图.png has no changes. Skipping commit and push."
          fi
