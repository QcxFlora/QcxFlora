name: 美图更换 # 工作流名称

on:
  schedule:
    # 每天 UTC 时间 00:00 运行 (北京时间上午 8:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动触发此工作流

permissions: # 明确授予工作流写入权限
  contents: write # 允许工作流修改仓库内容

jobs:
  update-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date for cache buster
        id: date
        run: echo "today=$(date +'%Y%m%d%H%M')" >> $GITHUB_OUTPUT

      - name: Update README.md with new image URL
        run: |
          # 定义基础URL部分，注意转义特殊字符用于sed的正则表达式
          BASE_URL_ESCAPED="https:\/\/api\.kxzjoker\.cn\/api\/wallhere\?type=bs"
          # 定义新的cachebuster值
          CACHEBUSTER_VALUE="${{ steps.date.outputs.today }}"

          # 使用sed命令进行替换
          # -E 启用扩展正则表达式
          # 地址匹配：/<img style="float: right;"/ 找到包含图片标签的行
          # 替换操作：
          #   s|...|...|g
          #   匹配模式：(src="${BASE_URL_ESCAPED})(=[0-9]*)?"
          #     - (src="${BASE_URL_ESCAPED})：捕获组1，匹配 src="https://api.kxzjoker.cn/api/wallhere?type=bs
          #     - (=[0-9]*)?：可选的捕获组，匹配现有的 = 和时间戳
          #     - "：匹配结束双引号
          #   替换模式：\1=${CACHEBUSTER_VALUE}"
          #     - \1：引用捕获组1的内容 (即 src="https://api.kxzjoker.cn/api/wallhere?type=bs)
          #     - =${CACHEBUSTER_VALUE}：追加 = 和新的时间戳
          #     - "：追加结束双引号
          sed -i -E "/<img style=\"float: right;\"/ { s|(src=\"${BASE_URL_ESCAPED})(=[0-9]*)?\"|\1=${CACHEBUSTER_VALUE}\"|g }" README.md

          # 检查是否有更改，如果有，则提交并推送
          if ! git diff --quiet README.md; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "chore: Update daily image URL in README.md [skip ci]"
            git push
            echo "README.md updated and pushed."
          else
            echo "No changes to README.md. Skipping commit and push."
          fi
